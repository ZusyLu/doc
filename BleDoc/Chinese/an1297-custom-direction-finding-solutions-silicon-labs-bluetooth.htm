<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>AN1297: Custom Direction-Finding Solutions using Silicon Labsâ€™ Bluetooth Stack</title><meta name="author" content="Silicon Labs"/><style type="text/css"> * {margin:0; padding:0; text-indent:0; }
 h1 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 24pt; }
 .s1 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 6pt; }
 .s2 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s3 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .p, p { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; margin:0pt; }
 .s4 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s5 { color: #007693; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 h4 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 11pt; }
 .a { color: #00F; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: underline; font-size: 9pt; }
 .s7 { color: #00F; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: underline; font-size: 9pt; }
 .s8 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9pt; }
 .s9 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s10 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s11 { color: #FFF; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9pt; }
 .s12 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s13 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s14 { color: black; font-family:"Cambria Math", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s15 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 6pt; }
 .s16 { color: black; font-family:"Cambria Math", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 6.5pt; vertical-align: -2pt; }
 .s17 { color: black; font-family:"Cambria Math", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 6.5pt; }
 .s18 { color: #049; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 h2 { color: #FFF; font-family:"Lucida Sans", sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 20pt; }
 .s19 { color: #FFF; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s20 { color: #4C4D4F; font-family:"Lucida Sans", sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 10pt; }
 .s21 { color: #424242; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s22 { color: #424242; font-family:"Lucida Sans", sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 7pt; }
 .s23 { color: #4C4D4F; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 7pt; }
 .s24 { color: #4C4D4F; font-family:"Arial Black", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 7pt; }
 .s26 { color: #4C4D4F; font-family:"Lucida Sans", sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 7pt; }
 .s28 { color: #0086DD; font-family:"Lucida Sans", sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 7pt; }
 .s29 { color: #4C4D4F; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 4pt; vertical-align: 2pt; }
 h3 { color: #FB1725; font-family:"Lucida Sans", sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 14pt; }
 li {display: block; }
 #l1 {padding-left: 0pt; }
 #l1> li>*:first-child:before {content: "ï‚· "; color: black; font-family:Symbol, serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 li {display: block; }
 #l2 {padding-left: 0pt;counter-reset: d1 1; }
 #l2> li>*:first-child:before {counter-increment: d1; content: counter(d1, decimal)" "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 11pt; }
 #l2> li:first-child>*:first-child:before {counter-increment: d1 0;  }
 #l3 {padding-left: 0pt;counter-reset: d2 1; }
 #l3> li>*:first-child:before {counter-increment: d2; content: counter(d1, decimal)"."counter(d2, decimal)" "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9pt; }
 #l3> li:first-child>*:first-child:before {counter-increment: d2 0;  }
 #l4 {padding-left: 0pt;counter-reset: d2 1; }
 #l4> li>*:first-child:before {counter-increment: d2; content: counter(d1, decimal)"."counter(d2, decimal)" "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9pt; }
 #l4> li:first-child>*:first-child:before {counter-increment: d2 0;  }
 #l5 {padding-left: 0pt; }
 #l5> li>*:first-child:before {content: "ï‚· "; color: black; font-family:Symbol, serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 table, tbody {vertical-align: top; overflow: visible; }
</style></head><body><p style="padding-left: 23pt;text-indent: 0pt;text-align: left;"><span><img width="127" height="62" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_001.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><h1 style="padding-top: 11pt;padding-left: 23pt;text-indent: 0pt;text-align: left;">AN1297: Custom Direction-Finding</h1><p style="text-indent: 0pt;text-align: left;"><span><img width="37" height="37" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_002.png"/></span></p><h1 style="padding-left: 22pt;text-indent: 0pt;text-align: left;">Solutions using the Silicon Labs Bluetooth Stack</h1><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 21pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="724" height="1" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_003.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="207" height="1" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_004.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s1" style="padding-top: 4pt;padding-bottom: 1pt;padding-left: 13pt;text-indent: 0pt;text-align: left;">KEY POINTS</p><p style="padding-left: 11pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="208" height="1" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_005.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><ul id="l1"><li><p class="s2" style="padding-left: 20pt;text-indent: -7pt;text-align: left;">Constant Tone Extension</p></li><li><p class="s2" style="padding-top: 3pt;padding-left: 20pt;text-indent: -7pt;text-align: left;">Antenna Switching</p></li><li><p class="s2" style="padding-top: 3pt;padding-left: 20pt;text-indent: -7pt;text-align: left;">IQ samples</p></li><li><p class="s2" style="padding-top: 3pt;padding-left: 20pt;text-indent: -7pt;text-align: left;">Phase compensation</p></li></ul><p style="text-indent: 0pt;text-align: left;"/><p class="s3" style="padding-top: 4pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">Bluetooth 5.1 introduced support for Direction Finding by adding the option to send and receive Constant Tone Extensions (CTEs) after Bluetooth packets. This makes it possible to measure the phase of the incoming signal on different antennas. However, calculating the direction of the incoming signal from the measured phases is the responsibility of the application, and not of the Bluetooth stack. This document explains the interface between the stack and the application regarding phase measurements to enable implementing custom direction-finding solutions using Silicon Labsâ€™ Bluetooth stack. The information in this document provides an alternative to using the Silicon Labs customizable reference implementation, and is intended for developers who have a deep understanding of direction-finding algorithms and prefer to develop their own solution.</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">Developers who prefer to start with the Silicon Labs customizable direction finding solution should refer to  <i>AN1296: Application Development with the Silicon Labs RTL Library </i>instead of this document.</p><p class="s5" style="padding-bottom: 2pt;text-indent: 0pt;text-align: right;">Introduction</p><p style="padding-left: 21pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="724" height="1" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_006.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l2"><li><h4 style="padding-left: 40pt;text-indent: -18pt;text-align: left;"><a name="bookmark0">Introduction</a></h4><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s7" style="padding-left: 22pt;text-indent: 0pt;text-align: justify;"><span class="p">This document explains how The Silicon Labs Bluetooth stack supports Direction Finding. Before going forward, the reader must have a basic knowledge of Direction Finding. To learn the basics, refer to </span><span class="s4">UG103.18: BluetoothÂ® Direction Finding Fundamentals</span><a href="https://www.bluetooth.com/wp-content/uploads/Files/developer/1903_RDF_Technical_Overview_FINAL.pdf" class="s10" target="_blank">. Reading the Technical Overview of Bluetooth direction Finding published by the Bluetooth SIG: </a>https://www.bluetooth.com/wp-<a href="https://www.bluetooth.com/wp-content/uploads/Files/developer/1903_RDF_Technical_Overview_FINAL.pdf" style=" color: #00F; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt;" target="_blank"> </a>content/uploads/Files/developer/1903_RDF_Technical_Overview_FINAL.pdf is also recommended<span class="p">.</span></p><p style="padding-top: 7pt;padding-left: 23pt;text-indent: 0pt;text-align: justify;">Direction Finding, which is estimating the angle of the incoming signal, is based on the concept of antenna arrays, where multiple an- tennas specially arranged in space sample the same reference signal. The reference signal is a continuous wave where both frequency and phase are maintained over a time interval long enough to be sampled on all antennas. The samples are then turned into phase differences, and phase differences are turned into angle estimation.</p><p style="padding-top: 8pt;padding-left: 23pt;text-indent: 0pt;text-align: justify;">Since Bluetooth 5.1 introduced Constant Tone Extensions (CTEs) that can be applied after regular Bluetooth packets, the Silicon Labs Bluetooth stack makes it possible to sample these extensions on different antennas and provide the antenna samples to the applica- tion. This document explains the antenna sample format. The samples can be used by anyone who wants to implement their own direc- tion-finding application that turns antenna samples into angle estimation.</p><p style="padding-top: 8pt;padding-left: 23pt;text-indent: 0pt;text-align: justify;">If you are unfamiliar with direction finding, or if you are familiar with the concept but you do not have a deep understanding of angle estimator algorithms, Silicon Labs strongly recommends using the RTL library in your application. The RTL library provides a full solu- tion to calculate the angle of the incoming signal from antenna samples in a real world environment. To learn more about the Silicon Labs solution, refer to <i>AN1296: Application Development with the Silicon Labs RTL Library. </i>If you decide to continue development using the Silicon Labs RTL library, you can skip this document.</p><p class="s5" style="padding-bottom: 2pt;text-indent: 0pt;text-align: right;">Constant Tone Extension</p><p style="padding-left: 21pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="724" height="1" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_007.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><h4 style="padding-left: 40pt;text-indent: -18pt;text-align: left;"><a name="bookmark1">Constant Tone Extension</a></h4><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l3"><li><p class="s8" style="padding-top: 10pt;padding-left: 51pt;text-indent: -28pt;text-align: left;"><a name="bookmark2">Concept</a></p><p style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">To determine the angle of the incoming signal it is essential to transmit a signal with continuous phase, constant amplitude, and con- stant frequency over a time period long enough to be sampled by all receiver antennas. Transmitting a CW (continuous wave) signal for a long time is not recommended outside of test environments, because it has a very sharp spectrum and can cause serious interfer- ence with other devices working in the 2.4 GHz frequency range. Therefore, a short CW must be used, and the transmitter and the receiver must be synchronized so that both know when the CW signal is sent.</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">Many solutions can be found to overcome this simple problem, and indeed there are many indoor positioning solutions on the market already using direction-finding algorithms. None of them is based on a well-known standard, however. The Bluetooth standard, in con- trast, is widespread, and it solves the synchronization problem by its nature: Bluetooth packets are sent with very strict timing, and the peer devices resynchronize their clocks on each reception.</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">Bluetooth 5.1 introduced a new method to request and send short CW signals as an extension of a normal package. This extension is called Constant Tone Extension (CTE), and it is sent after the CRC of the package when requested.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 99pt;text-indent: 0pt;text-align: left;"><span><img width="513" height="43" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_008.gif"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: justify;">CTEs can be sent both through a connection (in LL_CTE_RSP packets after an LL_CTE_REQ packet was received), and in periodic advertisements (in AUX_SYNC_IND packets). Additionally, the Silicon Labs Bluetooth stack provides a non-standard solution where CTEs can be sent in extended advertisements (AUX_ADV_IND packets), which makes Direction Finding much more scalable regarding the number of assets to be located. For more info on CTEs see the <i>Bluetooth Core Specification</i>, v5.1 or later.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s8" style="padding-left: 51pt;text-indent: -28pt;text-align: left;"><a name="bookmark3">Sending and Receiving CTEs</a></p><p style="padding-top: 7pt;padding-left: 23pt;text-indent: 0pt;text-align: justify;">To enable CTE responses on a connection use the API <span class="s9">sl_bt_cte_transmitter_enable_connection_cte() </span>on the CTE transmitter side. To send a CTE request from the receiver to the transmitter, use the API <span class="s9">sl_bt_cte_receiver_enable_connection_cte() </span>on the receiver side. If CTE responses are enabled on the transmitter side, the Bluetooth stack automatically responds to each CTE request with a CTE response.</p><p style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">To transmit CTEs in periodic advertisements, first start a periodic advertiser on the transmitter side and then use the API <span class="s9">sl_bt_cte_transmitter_enable_connectionless_cte()</span>. To start listening to CTEs attached to periodic advertise- ments, first establish a periodic synchronization on the receiver side and then use the API <span class="s9">sl_bt_cte_receiver_enable_connectionless_cte()</span>.</p><p style="padding-top: 7pt;padding-left: 23pt;text-indent: 0pt;text-align: justify;">To transmit CTEs in Silicon Labs proprietary extended advertisements, first start a (regular) extended advertisement on the transmitter side, and then use the API <span class="s9">sl_bt_cte_transmitter_enable_silabs_cte()</span>. To start listening to CTEs attached to Silicon Labs proprietary extended advertisements, first start scanning on the receiver side and then use the API sl_bt_cte_receiver_enable_silabs_cte().</p><p style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">Any time a CTE is received by the Bluetooth stack (either via connection or in advertisements), the Bluetooth stack raises an iq_report event. Depending on the mode of transmission, this means either an sl_bt_evt_cte_receiver_connection_iq_report event, an sl_bt_evt_cte_receiver_connectionless_iq_report event, or an sl_bt_evt_cte_receiver_silabs_iq_report event. Each event includes an array of IQ samples. The following sections detail what these samples mean and how to interpret them.</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;"><a href="http://docs.silabs.com/" class="s10" target="_blank">Note: To get the APIs listed above working, CTE Transmitter and CTE Receiver Software components need to be installed in your project. For more information on the API see the Bluetooth API Reference on </a><a href="http://docs.silabs.com/" class="a" target="_blank">http://docs.silabs.com</a><a href="http://docs.silabs.com/" class="s10" target="_blank">.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li></ol></li><li><h4 style="padding-top: 4pt;padding-left: 40pt;text-indent: -18pt;text-align: left;"><a name="bookmark4">Interpreting IQ Samples</a></h4><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l4"><li><p class="s8" style="padding-top: 10pt;padding-left: 51pt;text-indent: -28pt;text-align: left;"><a name="bookmark5">Sampling</a><a name="bookmark9">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">Although the Constant Tone Extension is a simple continuous wave â€“ with a variable length of 16 Î¼s to 160 Î¼s â€“ it is divided into peri- ods as defined in the Bluetooth Core Specification (Vol. 6, Part B, Section 2.5).</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">The first 4 Î¼s of the Constant Tone Extension is called the guard period and the next 8 Î¼s is called the reference period. After the refer- ence period, the Constant Tone Extension consists of a sequence of alternating switch slots and sample slots, each either 1 Î¼s or 2 Î¼s long, as specified by the application using the CTE Transmitter and CTE Receiver APIs. 2-Î¼s slots make it possible to use a cheaper RF switch between the antennas that has a longer transition time. 1-Î¼s slots make it possible to sample each antenna multiple times, which can help reduce the effect of noise and result in better accuracy.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 29pt;text-indent: 0pt;text-align: left;"><span><img width="704" height="244" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_009.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: justify;">Once a CTE has started, the radio starts sampling the In-phase (I) and Quadrature (Q) components of the baseband signal with its native sample rate. The samples are then downsampled to 1 sample/Î¼s sample rate. The first 4 samples (taken in the guard period) are discarded, then 8 samples (taken in the reference period) are stored in the sample buffer. Finally, every sample taken in switching slots is discarded and every sample taken in sample slots is stored in the sample buffer. In case of 2-Î¼s slots, only one sample is kept for each sample slot. Stored samples are marked with filled circles on the previous figure.</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">At this point, N = 8 + (L â€“ 12) / 2 / S number of samples are in both the In-phase (I) and in the Quadrature (Q) sample buffer, where L is the length of the CTE in microseconds, and S is the length of the slots in microseconds. The I and Q samples are merged into a com- mon IQ sample buffer with 2N elements so that I and Q samples follow each other alternating:</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">I(0), Q(0), I(1), Q(1), I(2), Q(2), I(3), Q(3), â€¦ I(N), Q(N).</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">This IQ sample buffer is passed to the application for further processing.</p></li><li><p class="s8" style="padding-top: 7pt;padding-left: 51pt;text-indent: -28pt;text-align: left;"><a name="bookmark6">Antenna switching</a></p><p style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">The goal of CTE is, to be able to sample the same continuous wave on different antennas. Since the radio can only sample on one antenna at a time, an RF path switching network must be created among the antennas, as shown in the following figure.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="684" height="263" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_010.gif"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">This way, any antenna can be connected with the EFR32 through control pins. The Bluetooth stack is designed so that it can drive up to six output pins to control the RF switches during CTE reception. With this solution up to 64 antennas can be addressed. As an example, on the previous image the four antennas can be addressed with the following addresses:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:50.85pt" cellspacing="0"><tr style="height:15pt"><td style="width:154pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#808080"><p class="s11" style="padding-top: 2pt;padding-left: 58pt;padding-right: 58pt;text-indent: 0pt;text-align: center;">address</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#808080"><p class="s11" style="padding-top: 2pt;padding-left: 36pt;padding-right: 36pt;text-indent: 0pt;text-align: center;">pin1</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#808080"><p class="s11" style="padding-top: 2pt;padding-left: 44pt;padding-right: 44pt;text-indent: 0pt;text-align: center;">pin0</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#808080"><p class="s11" style="padding-top: 2pt;padding-left: 36pt;padding-right: 36pt;text-indent: 0pt;text-align: center;">antenna</p></td></tr><tr style="height:15pt"><td style="width:154pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;padding-left: 58pt;padding-right: 57pt;text-indent: 0pt;text-align: center;">0x00</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;text-indent: 0pt;text-align: center;">0</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;text-indent: 0pt;text-align: center;">0</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;padding-left: 36pt;padding-right: 36pt;text-indent: 0pt;text-align: center;">#1</p></td></tr><tr style="height:15pt"><td style="width:154pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;padding-left: 58pt;padding-right: 57pt;text-indent: 0pt;text-align: center;">0x01</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;text-indent: 0pt;text-align: center;">0</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;padding-left: 36pt;padding-right: 36pt;text-indent: 0pt;text-align: center;">#2</p></td></tr><tr style="height:15pt"><td style="width:154pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;padding-left: 58pt;padding-right: 57pt;text-indent: 0pt;text-align: center;">0x02</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;text-indent: 0pt;text-align: center;">0</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;padding-left: 36pt;padding-right: 36pt;text-indent: 0pt;text-align: center;">#3</p></td></tr><tr style="height:15pt"><td style="width:154pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;padding-left: 58pt;padding-right: 57pt;text-indent: 0pt;text-align: center;">0x03</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:110pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 2pt;padding-left: 36pt;padding-right: 36pt;text-indent: 0pt;text-align: center;">#4</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 23pt;text-indent: 0pt;text-align: justify;">The six control pins can be selected in the configuration file of the <b>Platform &gt; Radio &gt; RAIL Utility, AoX </b>software component.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 192pt;text-indent: 0pt;text-align: left;"><span><img width="263" height="295" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_011.jpg"/></span></p><p style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">The antenna switching pattern, which is the order of addressing the different antennas, can be set with the CTE Receiver and CTE Transmitter Bluetooth APIs as described in the Bluetooth API Reference. For example, to set the antenna switching pattern for connec- tionless AoA mode, use the following code:</p><p class="s13" style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;line-height: 10pt;text-align: left;">// Antenna switching pattern</p><p class="s13" style="padding-left: 23pt;text-indent: 0pt;line-height: 10pt;text-align: left;">static const uint8_t antenna_array[16] = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15 };</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s13" style="padding-left: 23pt;text-indent: 0pt;text-align: left;">sl_bt_cte_receiver_enable_connectionless_cte(sync_handle,</p><p class="s13" style="padding-left: 266pt;text-indent: 0pt;text-align: left;">CTE_SLOT_DURATION, CTE_COUNT,</p><p class="s13" style="padding-left: 266pt;text-indent: 0pt;text-align: left;">sizeof(antenna_array), antenna_array);</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: justify;">The Bluetooth stack automatically controls the antenna switch pins in the switch slots of the CTE according to the defined switching pattern. The switching pattern can have any length between 1 and 35. It is repeated over the CTE time period, in other words once the end of the pattern is reached it starts over, and this is repeated until the end of the CTE signal. Note that the first switch happens after the reference period, which means that the first antenna in the pattern will be sampled 8 times.</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">Considering all of this, a switching pattern of [4 3 2 1] results in the following IQ samples:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:13.89pt" cellspacing="0"><tr style="height:19pt"><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I4</p></td><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q4</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I4</p></td><td style="width:22pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q4</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I4</p></td><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q4</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I4</p></td><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q4</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I4</p></td><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q4</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I4</p></td><td style="width:22pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q4</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I4</p></td><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q4</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I4</p></td><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q4</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I3</p></td><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q3</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I2</p></td><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q2</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I1</p></td><td style="width:22pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q1</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I4</p></td><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q4</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">I3</p></td><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D9D9D9"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Q3</p></td><td style="width:22pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s12" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">â€¦</p></td></tr></table><p style="padding-top: 7pt;padding-left: 23pt;text-indent: 0pt;text-align: justify;">where the indices mean the address of the antenna. Note, that the addresses do not necessarily have to be consecutive values starting from 0. Addresses can be any value between 0 and 63 and they should always be derived from the RF switching network.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s8" style="padding-left: 51pt;text-indent: -28pt;text-align: left;"><a name="bookmark7">Phase Retrieval</a></p><p style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">IQ samples are passed to the application in a form of a uint8 array, with each I and Q sample taking 1-1 byte. Note, however, that I and Q samples are signed integers, which means that the uint8 values must be casted to int8 values immediately after the application re- ceives them from the Bluetooth stack. Using uint8 values is simply a limitation of the BGAPI.</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;line-height: 107%;text-align: justify;">I and Q samples represent the in-phase and quadrature components of the signal, which can be easily translated into amplitude and phase:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 244pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="39" height="1" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_012.png"/></span></p><p class="s14" style="padding-left: 182pt;text-indent: 0pt;text-align: center;">Amplitude =  ï¿½ğ¼ğ¼2 + ğ‘„ğ‘„2                     Phase =  arctan2(ğ‘„ğ‘„, ğ¼ğ¼)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 214pt;text-indent: 0pt;text-align: left;"><span><img width="210" height="212" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_013.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 23pt;text-indent: 0pt;text-align: justify;">Note that the amplitude does not represent the absolute amplitude of the signal, since it is compensated with AGC (automatic gain control). To learn the absolute amplitude of the signal, RSSI must be accounted for as well. Direction finding algorithms do not usually need to do this, since all that matters is the phase difference and amplitude difference between antennas.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s8" style="padding-left: 51pt;text-indent: -28pt;text-align: left;"><a name="bookmark8">Phase compensation</a></p><p style="padding-top: 7pt;padding-left: 23pt;text-indent: 0pt;text-align: justify;">Ideally, all antennas should be sampled at the same time to easily calculate the phase difference between them. However, this is not possible with a single radio. The only way to sample more than one antenna is time division, which also means that the sampling is shifted in time.</p><p style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">Time shift also means a phase shift of <span class="s14">ğœ™ğœ™ = 2ğœ‹ğœ‹ğœ‹ğœ‹ğœ‹ğœ‹</span>, where <i>Ï† </i>is the phase shift, <i>f </i>is the frequency and <i>t </i>is time. Although the carrier fre- quency is mixed and downsampled by the radio such that it corresponds to a DC signal in the baseband, the CTE will not have zero frequency in the baseband for two reasons:</p><ul id="l5"><li><p style="padding-top: 3pt;padding-left: 37pt;text-indent: -14pt;text-align: justify;">CTE is not using the carrier frequency. Instead it is generated as a sequence of continuous non-whitened 1â€™s, which corresponds to a continuous wave with the frequency of <span class="s14">ğœ‹ğœ‹ğ‘ğ‘ + ğœ‹ğœ‹Î”</span>, where <i>f</i><span class="s15">c  </span>is the carrier frequency and <i>f</i><span class="s15">Î”  </span>is the frequency deviation. This corresponds to a frequency of <i>f</i><span class="s15">Î” </span>in the baseband.</p></li><li><p style="padding-top: 3pt;padding-left: 37pt;text-indent: -14pt;text-align: justify;">Oscillators are not always perfectly tuned, which results in an offset between the ideal carrier frequency and the real carrier fre- quency. This again introduces a frequency shift <i>f</i><span class="s15">offset </span>in the CTE frequency.</p></li></ul><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">Considering this, the frequency of the CTE signal in the baseband is <i>f</i><span class="s15">Î” </span>+ <i>f</i><span class="s15">offset</span>, where <i>f</i><span class="s15">Î” </span>= 250kHz according to the Bluetooth specifica- tion, and <i>f</i><span class="s15">offset </span>is in the order of 10kHz. Consequently, the phase shift between two consecutive samples with a 1-Î¼s difference is around</p><p class="s14" style="padding-left: 22pt;text-indent: 0pt;text-align: justify;">ğœ™ğœ™ = 2ğœ‹ğœ‹(ğœ‹ğœ‹<span class="s16">Î”</span><span class="s17"> </span>+ ğœ‹ğœ‹<span class="s16">o</span><span class="s17">ffset</span>)ğœ‹ğœ‹  â‰… 2ğœ‹ğœ‹  âˆ™ 0.25  âˆ™ 1 = 0.5ğœ‹ğœ‹ = 90Â°<span class="p">. Taking the offset frequency into account as well, it might vary between 80Â°-100Â°.</span></p><p style="padding-top: 6pt;padding-left: 23pt;text-indent: 0pt;text-align: justify;">Since the reference samples are taken on the same antenna, they can be used to measure the actual phase shift over a 1-Î¼s time period. It is strongly recommended to calculate the phase shift for each packet, as it may vary between packets. That is, every time an iq_report event is received, the first 8 IQ samples should be used to determine the phase shift for the actual packet. This can be done either by averaging the phase differences between the first 8 samples or by applying a median filter on those phase differences.</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;"><a href="#bookmark9" class="s10">Note, however, that once a phase shift for 1 Î¼s is calculated, this value should be multiplied and used to compensate for the phase shift between samples after the reference period due to the non-sampled switching slots, as illustrated in section </a><a href="#bookmark9" class="s18">3.1 Sampling</a>. For 1- Î¼s slots, 2 times the value should be used, and for 2- Î¼s slots, 4 times the value should be used.</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">The content of the IQ sample buffer for a <i>k</i>-long antenna switching pattern is illustrated in the following figure along with the expected phase differences between the consecutive IQ samples.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 28pt;text-indent: 0pt;text-align: left;"><span><img width="704" height="150" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_014.jpg"/></span></p><p class="s5" style="padding-bottom: 2pt;text-indent: 0pt;text-align: right;">Angle of Arrival / Angle of Departure</p><p style="padding-left: 21pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="724" height="1" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_015.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li></ol></li><li><h4 style="padding-left: 40pt;text-indent: -18pt;text-align: left;"><a name="bookmark10">Angle of Arrival / Angle of Departure</a></h4></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: justify;">The previous sections primarily discuss the case of Angle of Arrival (AoA) method, where the transmitter sends a continuous wave on a single antenna, and the receiver samples the incoming signal on multiple antennas.</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: justify;">In the Angle of Departure (AoD) method, the antenna switching happens on the transmitter side, and the receiver samples the incoming signal on a single antenna. This, however, does not change anything on the structure and interpretation of the IQ samples. The fact that antenna switching happens on the transmitter side does not affect the result at all. The only difference is in the configuration. In the case of AoD the switching pins must be set up on the transmitter, and both the transmitter and the receiver must know the switching pattern. This contrasts with AoA, where the switching pattern need only be configured on the receiver side.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 29pt;text-indent: 0pt;text-align: left;"><span><img width="691" height="299" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_016.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><h2 style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Simplicity Studio</h2><p class="s19" style="padding-top: 14pt;padding-left: 36pt;text-indent: 0pt;line-height: 122%;text-align: left;">One-click access to MCU and wireless tools, documentation, software, source code libraries &amp; more. Available for Windows, Mac and Linux!</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="768" height="432" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_017.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:63.94pt" cellspacing="0"><tr style="height:99pt"><td style="width:98pt" bgcolor="#231F20"><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 15pt;text-indent: 0pt;text-align: left;"><span><img width="66" height="66" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_018.png"/></span></p><p style="padding-top: 10pt;padding-left: 1pt;padding-right: 19pt;text-indent: 0pt;text-align: center;"><a href="https://www.silabs.com/solutions/iot" class="s20">IoT Portfolio</a></p><p style="padding-top: 1pt;padding-left: 1pt;padding-right: 19pt;text-indent: 0pt;line-height: 8pt;text-align: center;"><a href="http://www.silabs.com/IoT" class="s21">www.silabs.com/IoT</a></p></td><td style="width:126pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 18pt;padding-right: 8pt;text-indent: 0pt;text-align: center;"><a href="https://www.silabs.com/simplicity" class="s20">SW/HW</a></p><p style="padding-top: 1pt;padding-left: 18pt;padding-right: 8pt;text-indent: 0pt;line-height: 8pt;text-align: center;"><a href="http://www.silabs.com/simplicity" class="s21">www.silabs.com/simplicity</a></p></td><td style="width:126pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 18pt;padding-right: 8pt;text-indent: 0pt;text-align: center;"><a href="https://www.silabs.com/about-us/corporate-responsibility/commitment-to-quality" class="s20">Quality</a></p><p style="padding-top: 1pt;padding-left: 18pt;padding-right: 8pt;text-indent: 0pt;line-height: 8pt;text-align: center;"><a href="http://www.silabs.com/quality" class="s21">www.silabs.com/quality</a></p></td><td style="width:126pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 12pt;text-indent: 0pt;text-align: left;"><a href="https://www.silabs.com/community" class="s20" target="_blank">Support &amp; Community</a></p><p style="padding-top: 1pt;padding-left: 13pt;text-indent: 0pt;line-height: 8pt;text-align: left;"><a href="http://www.silabs.com/community" class="s21">www.silabs.com/community</a></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="131" height="131" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_019.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="131" height="131" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_020.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="131" height="131" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_021.png"/></span></p><p class="s22" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Disclaimer</p><p class="s23" style="padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">Silicon Labs intends to provide customers with the latest, accurate, and in-depth documentation of all peripherals and modules available for system and software imple- menters using or intending to use the Silicon Labs products. Characterization data, available modules and peripherals, memory sizes and memory addresses refer to each <span class="s24">specific device, and â€œTypicalâ€ parameters provided can and do vary in different applications. Application examples described herein are for illustrative purposes only. Silicon Labs reserves the right to make changes without further notice to the product information, specifications, and descriptions herein, and does not give warranties as to the accuracy or completeness of the included information. Without prior notification, Silicon Labs may update product firmware during the manufacturing process for security or reliability reasons. Such changes will not alter the specifications or the performance of the product. Silicon Labs shall have no liability for the consequences of use of the infor</span>- mation supplied in this document. This document does not imply or expressly grant any license to design or fabricate any integrated circuits. The products are not designed or <span class="s24">authorized to be used within any FDA Class III devices, applications for which FDA premarket approval is required or Life Support Systems without the specific written consent of Silicon Labs. A â€œLife Support Systemâ€ is any product or system intended to support or sustain life and/or health, which, if it fails, can be reasonably expected to result in significant personal injury or death. Silicon Labs products are not designed or authorized for military applications. Silicon Labs products shall under no circumstances be used </span>in weapons of mass destruction including (but not limited to) nuclear, biological or chemical weapons, or missiles capable of delivering such weapons. Silicon Labs disclaims <span class="s24">all express and implied warranties and shall not be responsible or liable for any injuries or damages related to use of a Silicon Labs product in such unauthorized applications. </span><b>Note: This content may contain offensive terminology that is now obsolete. Silicon Labs is replacing these terms with inclusive language wherever possible. For more </b><span class="s26">information, visit </span><a href="https://www.silabs.com/about-us/inclusive-lexicon-project" class="s28" target="_blank">www.silabs.com/about-us/inclusive-lexicon-project</a></p><p class="s26" style="padding-top: 8pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Trademark Information</p><p class="s29" style="padding-top: 1pt;padding-left: 5pt;text-indent: 0pt;line-height: 117%;text-align: justify;"><span class="s23">Silicon Laboratories Inc.</span>Â®<span class="s23">, Silicon Laboratories</span>Â®<span class="s23">, Silicon Labs</span>Â®<span class="s23">, SiLabs</span>Â® <span class="s23">and the Silicon Labs logo</span>Â®<span class="s23">, Bluegiga</span>Â®<span class="s23">, Bluegiga Logo</span>Â®<span class="s23">, Clockbuilder</span>Â®<span class="s23">, CMEMS</span>Â®<span class="s23">, DSPLL</span>Â®<span class="s23">, EFM</span>Â®<span class="s23">, EFM32</span>Â®<span class="s23">, EFR, Ember</span>Â®<span class="s24">, Energy Micro, Energy Micro logo and combinations thereof, â€œthe worldâ€™s most energy friendly microcontrollersâ€, Ember</span>Â®<span class="s23">, EZLink</span>Â®<span class="s23">, EZRadio</span>Â®<span class="s23">, EZRadioPRO</span>Â®<span class="s23">, Gecko</span>Â®<span class="s23">, Gecko OS, Gecko OS Studio, ISOmodem</span>Â®<span class="s23">, Precision32</span>Â®<span class="s23">, ProSLIC</span>Â®<span class="s23">, Simplicity Studio</span>Â®<span class="s23">, SiPHY</span>Â®<span class="s23">, Telegesis, the Telegesis Logo</span>Â®<span class="s23">, USBXpress</span>Â® <span class="s23">, Zentri, the Zentri logo and Zentri DMS, Z-Wave</span>Â®<span class="s23">, and others are trademarks or registered trademarks of Silicon Labs. ARM, CORTEX, Cortex-M3 and THUMB are trademarks or registered trademarks of ARM Hold- ings. Keil is a registered trademark of ARM Limited. Wi-Fi is a registered trademark of the Wi-Fi Alliance. All other products or brand names mentioned herein are trademarks of their respective holders.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="148" height="73" alt="image" src="an1297-custom-direction-finding-solutions-silicon-labs-bluetooth/Image_022.png"/></span></p><p class="s26" style="padding-top: 5pt;padding-left: 149pt;text-indent: 0pt;text-align: left;">Silicon Laboratories Inc. 400 West Cesar Chavez Austin, TX 78701</p><p class="s26" style="padding-left: 149pt;text-indent: 0pt;line-height: 8pt;text-align: left;">USA</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 149pt;text-indent: 0pt;text-align: left;"><h3 href="http://www.silabs.com/">www.silabs.com</h3></p></body></html>
